---
title: "Model results"
output: html_notebook
---


```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = 'C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/')
library(dplyr)
library(ggplot2)
library(compare)
library(rjson)
library(data.table)

#setwd("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/")
# REMEMBER: the working directory of the R sessions and the working directory of the notebook are different things!!!!

```

```{r import_results}
sembert_output<- read.csv("experiment-5/outputs/sembert_concat_1/dev-results.tsv", header = FALSE, sep='\t')

```

```{r check_acc}

sembert_results <- sembert_output %>%
  rowwise() %>%
  mutate(output= which.max(list(V1,V2,V3))-1)%>%
  mutate(right = sum(V4==output, na.rm=T))

print(sum(sembert_results$right)/nrow(sembert_results))

```

```{r import_results}
bert_output<- read.csv("experiment-5/outputs/bert_base/dev-results.tsv", header = FALSE, sep='\t')

```

```{r check_acc}

bert_results <- bert_output %>%
  rowwise() %>%
  mutate(output= which.max(list(V1,V2,V3))-1)%>%
  mutate(right = sum(V4==output, na.rm=T))

print(sum(bert_results$right)/nrow(bert_results))
```
```{r add_indx}
bert_results <- cbind(head(bert_results, -1), V5 = sembert_results$V5) # I delete one row to match

```


```{r add_indx}

bert_right = bert_results$right
sembert_right = sembert_results$right

differing_rows = which(bert_right != sembert_right, arr.ind = FALSE)

all = merge(bert_results, sembert_results, by="V5")

all$ID <- seq.int(nrow(all))

differing <- all %>%
  filter(ID %in% differing_rows)

```


```{r import_results}
#dev<- read.csv("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/data/gear/gear-dev-data.tsv", header = FALSE, sep='\t')

dev <- read.table("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/data/gear/gear-dev-data.tsv", sep="\t", header=FALSE, comment.char="#",
                  na.strings=".", stringsAsFactors=FALSE,
                  quote="", fill=TRUE)

all_dev = merge(differing, head(dev, -1), by.x = "V5", by.y = "V1")

```

```{r import_results}
all_dev %>%
  group_by(right.y)%>%
  summarise(len_claim=mean(length(V3)), len_evidences = mean(length(V4)+length(V5)+length(V6)+length(V7)+length(V8)))

```

```{r import_results}
library("rjson")
json_data <- fromJSON(paste(readLines("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/data/gear/dev_srl_all.json"), collapse=""))

```
```{r import_results}

weights_12 <- fromJSON(paste(readLines("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/experiment-5/outputs/sembert_12/weights.json"), collapse=""))

```

```{r import_results}

embeddings <- weights_12$module.tag_model.embed.tag_embeddings.weight

tags <- c('[PAD]','[CLS]','[SEP]','B-V','I-V','B-ARG0','I-ARG0','B-ARG1','I-ARG1','B-ARG2','I-ARG2','B-ARG4','I-ARG4','B-ARGM-TMP','I-ARGM-TMP','B-ARGM-LOC','I-ARGM-LOC','B-ARGM-CAU','I-ARGM-CAU','B-ARGM-PRP','I-ARGM-PRP','O')


df  <-  as.data.frame(matrix(unlist(embeddings), nrow=length(unlist(embeddings[1]))), col.names=tags)

colnames(df) <- tags

# [(0, '[PAD]'), (1, '[CLS]'), (2, '[SEP]'), (3, 'B-V'), (4, 'I-V'), (5, 'B-ARG0'), (6, 'I-ARG0'), (7, 'B-ARG1'), (8, 'I-ARG1'), (9, 'B-ARG2'), (10, 'I-ARG2'), (11, 'B-ARG4'), (12, 'I-ARG4'), (13, 'B-ARGM-TMP'), (14, 'I-ARGM-TMP'), (15, 'B-ARGM-LOC'), (16, 'I-ARGM-LOC'), (17, 'B-ARGM-CAU'), (18, 'I-ARGM-CAU'), (19, 'B-ARGM-PRP'), (20, 'I-ARGM-PRP'), (21, 'O')]

```

```{r plot_embeddings}
library(tidyr)
library(dplyr)
library(ggplot2)

df %>%
  t()%>%
  pair

transposed <-df %>%
  t()%>%
  data.frame()

transposed <- setDT(transposed, keep.rownames = TRUE)[]

transposed%>%
  gather(key, value, -rn) %>%
  ggplot(aes(x = value, y = value)) + 
  geom_point() +
  facet_wrap(~key)

transposed.m <- melt(transposed, "rn")

ggplot(transposed.m, aes(value, value)) + 
  geom_point() + 
  facet_wrap(~variable, scales = "free")

```



```{r import_results}
sembert_12_output<- read.csv("experiment-5/outputs/sembert_12/dev-results.tsv", header = FALSE, sep='\t')

```

```{r check_acc}

sembert_12_results <- sembert_12_output %>%
  rowwise() %>%
  mutate(output= which.max(list(V1,V2,V3))-1)%>%
  mutate(right = sum(V4==output, na.rm=T))

print(sum(sembert_12_results$right)/nrow(sembert_12_results))

```