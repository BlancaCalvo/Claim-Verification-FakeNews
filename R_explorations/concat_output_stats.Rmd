---
title: "Model results"
output: html_notebook
---


```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = 'C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/')
library(dplyr)
library(ggplot2)
library(compare)
library(rjson)
library(data.table)

#setwd("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/")
# REMEMBER: the working directory of the R sessions and the working directory of the notebook are different things!!!!

```


```{r import_results}
json_data <- fromJSON(paste(readLines("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/data/gear/dev_srl_all.json"), collapse=""))

json_data[[1]]$evidence_srl$verbs[[1]]$tags

list_index = list()
list_i = list()

for (i in 1:length(json_data)){
  #print(i)
  list_index = append(list_index,json_data[[i]]$index)
  list_i = append(list_i, i)
} 

correspondence <- do.call(rbind.data.frame, Map('c', list_index, list_i))
colnames(correspondence) <- c("claim_index", "evidence_index")
```


```{r dev}
dev<- read.table("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/data/gear/dev_data_new.tsv", sep="\t", header=FALSE, comment.char="#", na.strings=".", stringsAsFactors=FALSE, quote="", fill=TRUE)


#all_dev = merge(head(dev, -1), all, by.x=("V1"), by.y=("V5"))


#all_dev %>%
#  group_by(right.sembert)%>%
#  summarise(len_claim=mean(nchar(V3)), len_evidences = mean(nchar(V4)+nchar(V5)+nchar(V6)+nchar(V7)+nchar(V8)))

```


```{r dev}
gold_dev<- read.table("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/data/gear/gold_evidence_dev.tsv", sep="\t", header=FALSE, comment.char="#", na.strings=".", stringsAsFactors=FALSE, quote="", fill=TRUE)
```


```{r compare_function}
table_results <- function(results1, results2) {
  
  right1 = results1$right
  right2 = results2$right

  differing_rows = which(right1 != right2, arr.ind = FALSE)
  
  #bert_results <- cbind(bert_results, V5 = aggregation_results$V5) # I delete one row to match

  all = merge(results1, results2, by="V5", suffixes = c(".1",".2"))

  all_dev = merge(dev, all, by.x=("V1"), by.y=("V5"))

  all_dev$ID <- seq.int(nrow(all_dev))


  all_dev$ID <- seq.int(nrow(all_dev))

  differing <- all_dev %>%
  filter(ID %in% differing_rows)

differing_improve <- all_dev %>%
  filter(ID %in% which(results1$right==0 & results2$right==1, arr.ind = FALSE))

differing_worse <- all_dev %>%
  filter(ID %in% which(results1$right==1 & results2$right==0, arr.ind = FALSE))

differing_improve %>%
  #filter(V1 %in% gold_dev$V4)%>%
  group_by(output.1, output.2)%>%
  summarise(counts = n(), proportion= n()/nrow(differing_improve), total_differing = nrow(differing_improve))%>%
  print()
  
differing_worse %>%
  #filter(V1 %in% gold_dev$V4)%>%
  group_by(output.1, output.2)%>%
  summarise(counts = n(), proportion= n()/nrow(differing_worse), total_differing = nrow(differing_worse))%>%
  print()

return(differing)
}

```

```{r import_results}
bert_results<- read.csv("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/experiment-5/outputs/bert_base/N_dev_results.tsv", header = FALSE, sep='\t')

bert_results <- bert_results %>%
  rowwise() %>%
  mutate(output= which.max(list(V1,V2,V3))-1)%>%
  mutate(right = sum(V4==output, na.rm=T))

print(sum(bert_results$right)/nrow(bert_results))

bert_results <- cbind(bert_results, V5 = dev$V1) # I delete one row to match

```

```{r import_results}
sembert_12_results<- read.csv("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/experiment-5/outputs/sembert_12/dev-results.tsv", header = FALSE, sep='\t')

sembert_12_results <- sembert_12_results %>%
  rowwise() %>%
  mutate(output= which.max(list(V1,V2,V3))-1)%>%
  mutate(right = sum(V4==output, na.rm=T))

print(sum(sembert_12_results$right)/nrow(sembert_12_results))

```

```{r comparison}

bert_small <- head(bert_results, -1)

differing <- table_results(bert_small, sembert_12_results)

```


```{r import_results}
aggregation<- read.csv("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/experiment-5/outputs/aggregation/dev-results.tsv", header = FALSE, sep='\t')

aggregation_results <- aggregation %>%
  rowwise() %>%
  mutate(output= which.max(list(V1,V2,V3))-1)%>%
  mutate(right = sum(V4==output, na.rm=T))

print(sum(aggregation_results$right)/nrow(aggregation_results))

```

```{r comparison}

table_results(bert_results, aggregation_results)

#table_results(sembert_small, aggregation_results)

```


```{r import_results}
dream_mapping <- read.csv("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/experiment-5/outputs/mapping/dream-dev-results.tsv", header = FALSE, sep='\t')

dream_mapping_results <- dream_mapping %>%
  rowwise() %>%
  mutate(output= which.max(list(V1,V2,V3))-1)%>%
  mutate(right = sum(V4==output, na.rm=T))

print(sum(dream_mapping_results$right)/nrow(dream_mapping_results))

```

```{r comparison}

table_results(bert_results, dream_mapping_results)


```


```{r import_results}
tag_mapping<- read.csv("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/experiment-5/outputs/mapping/tags1-dev-results.tsv", header = FALSE, sep='\t')

tag_mapping_results <- tag_mapping %>%
  rowwise() %>%
  mutate(output= which.max(list(V1,V2,V3))-1)%>%
  mutate(right = sum(V4==output, na.rm=T))

print(sum(tag_mapping_results$right)/nrow(tag_mapping_results))

```

```{r comparison}

table_results(bert_results, tag_mapping_results)


```

```{r inspection1}
#gold_unique <- gold_dev %>%
#  distinct(V3,.keep_all= TRUE)

#inspect = merge(differing, gold_dev, by.x=("V1"), by.y=("V4"), suffixes = c(".retrieved",".gold"))

go <- differing%>%
  filter(right.sembert==1)%>%
  filter(output.bert==1)%>%
  filter(output.sembert==0)%>%
  select(V1, V3, V4,V5,V6, V7, V8)

```


#inspect!!
instance <- go[16,]
instance

correspondence%>%
  filter(claim_index == instance$V1)

json_data[[25158]]$claim_srl

json_data[[25158]]$evidence_srl
