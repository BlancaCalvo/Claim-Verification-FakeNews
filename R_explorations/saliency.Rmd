---
title: "saliency"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = 'C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/')
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
library(dplyr)
library(ggplot2)
library(compare)
library(rjson)
library(data.table)
library(jsonlite)
library(tidyverse)
library(forcats)

#setwd("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/")
# REMEMBER: the working directory of the R sessions and the working directory of the notebook are different things!!!!

```

```{r load_data}
lines <- readLines("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/data/saliency/F-base-bert/F-base-bert-2_1_sal_l2")
lines <- lapply(lines, fromJSON)
lines <- lapply(lines, unlist)
metric1 <- bind_rows(lines)
lines <- readLines("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/data/saliency/F-base-bert/F-base-bert-2_1_guided_l2")
lines <- lapply(lines, fromJSON)
lines <- lapply(lines, unlist)
metric2 <- bind_rows(lines)
lines <- readLines("C:/Users/bcalvo/Box/bcalvo/Claim-Verification-FakeNews/data/saliency/F-base-bert/F-base-bert-2_1_inputx_l2")
lines <- lapply(lines, fromJSON)
lines <- lapply(lines, unlist)
metric3 <- bind_rows(lines)

list_metrics <- list(metric1,metric2,metric3)
list_metric_names <- c('saliency','guided','inputx')

example1_1 <- metric1[3,] # SUPPORTS
example1_2 <- metric2[3,] # SUPPORTS
example1_3 <- metric3[3,] # SUPPORTS
```

```{r select_data}

normalized<-function(y) {

  x<-y[!is.na(y)]

  x<-(x - min(x)) / (max(x) - min(x))

  y[!is.na(y)]<-x

  return(y)
  }

get_format_sal <- function (list_metrics,id, list_metric_names){
final_list = data.frame(V1=integer(),
                 ID=factor(), 
                 stat=character(), 
                 order=factor()) 
for(i in 1:length(list_metrics)) {
example <- list_metrics[[i]][id,]
#get_format_sal <- function (example){
token_names <- example%>%
  select(starts_with("tokens.token"))%>%
  t()%>%
  as.data.frame()

token_values <- example%>%
  select(starts_with("tokens.0"))%>%
  t()%>%
  as.data.frame()

token_values['ID'] <- token_names[,1]
token_values$ID = as.factor(token_values$ID)
token_values$V1 = as.numeric(token_values$V1)
#token_values$V1 = apply(token_values[,1],2,normalized)

token_values["stat"] <- as.factor(replicate(nrow(token_values), list_metric_names[i]))
token_values['order'] <- c(1:nrow(token_values))
token_values['order'] <- as.factor(token_values$order)

token_values <- token_values%>%
  filter(ID != '[PAD]')

final_list <- rbind(final_list, token_values)
}

return(final_list)
}
```

```{r plot_support}
metrics_list<- get_format_sal(list_metrics, 3, list_metric_names)

#token_values <- get_format_sal(example1_1)

metrics_list%>%
  #mutate(ID = fct_reorder(ID,order)) %>%
  #filter(ID!='NA')%>%
  ggplot(aes(x=order, y=stat, fill=V1)) + geom_tile()+
  scale_fill_gradient(low = "white", high = "#4186BE") +
  theme(axis.text.x = element_text(angle = 70, size = 7))+
  scale_x_discrete(labels=metrics_list[["ID"]][1:299])+
  #xlim(0, length(unique(metrics_list$ID)))
  

ggsave(file="image1.png", width=30, height=4, dpi=400)

```

```{r plot_refute}
metrics_list<- get_format_sal(list_metrics, 5, list_metric_names)

#token_values <- get_format_sal(example1_1)

metrics_list%>%
  #mutate(ID = fct_reorder(ID,order)) %>%
  #filter(ID!='NA')%>%
  ggplot(aes(x=order, y=stat, fill=V1)) + geom_tile()+
  scale_fill_gradient(low = "white", high = "#4186BE") +
  theme(axis.text.x = element_text(angle = 70, size = 7))+
  scale_x_discrete(labels=metrics_list[["ID"]][1:299])+
  #xlim(0, length(unique(metrics_list$ID)))
  

ggsave(file="image2.png", width=30, height=4, dpi=400)

```














